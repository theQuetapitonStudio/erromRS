<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<style>
body { font-family: sans-serif; }
#chat { height: 350px; overflow-y: auto; border: 1px solid #000; padding: 5px; }
.msg { margin: 4px 0; }
.user { font-weight: bold; }
</style>
</head>
<body>

<h3>Chat</h3>

<div id="chat"></div>

<input id="text" placeholder="Mensagem">
<input type="file" id="file">
<button onclick="send()">Enviar</button>

<script>
let username = localStorage.getItem("username");

while (!username) {
    const name = prompt("Escolha um nome:");
    if (name) {
        localStorage.setItem("username", name);
        username = name;
    }
}

const chat = document.getElementById("chat");
const ws = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") + location.host
);

ws.onmessage = e => {
    const msg = JSON.parse(e.data);

    if (msg.type === "history") {
        msg.data.forEach(addMsg);
    }

    if (msg.type === "message") {
        addMsg(msg.data);
    }
};

function addMsg(m) {
    const div = document.createElement("div");
    div.className = "msg";

    let content = m.text || "";
    if (m.file) {
        const ext = m.file.split(".").pop();
        if (["png","jpg","jpeg","gif","webp"].includes(ext)) {
            content += `<br><img src="${m.file}" width="200">`;
        } else if (["mp4","webm"].includes(ext)) {
            content += `<br><video src="${m.file}" controls width="250"></video>`;
        } else {
            content += `<br><a href="${m.file}" target="_blank">Arquivo</a>`;
        }
    }

    div.innerHTML = `<span class="user">${m.user}:</span> ${content}`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

async function send() {
    let fileUrl = null;
    const file = document.getElementById("file").files[0];

    if (file) {
        const form = new FormData();
        form.append("file", file);
        const res = await fetch("/upload", { method: "POST", body: form });
        const data = await res.json();
        fileUrl = data.url;
        document.getElementById("file").value = "";
    }

    ws.send(JSON.stringify({
        user: username,
        text: document.getElementById("text").value,
        file: fileUrl,
        time: Date.now()
    }));

    document.getElementById("text").value = "";
}
</script>

</body>
</html>
